#!/usr/bin/bash -e

source /usr/local/etc/action-shell/buildflags

pushd /tmp

git clone -b $(curl -s https://api.github.com/repos/ebiggers/libdeflate/tags | jq -r '.[0].name') \
    --depth 1 --single-branch --no-tags https://github.com/ebiggers/libdeflate
mkdir libdeflate/build
pushd libdeflate/build
cmake .. \
    -DCMAKE_BUILD_TYPE=release \
    -DCMAKE_AR=$(which gcc-ar) \
    -DCMAKE_RANLIB=$(which gcc-ranlib) \
    -DCMAKE_C_FLAGS_RELEASE="$GCC_CFLAGS" \
    -DCMAKE_EXE_LINKER_FLAGS="$GCC_LDFLAGS" \
    -DLIBDEFLATE_BUILD_SHARED_LIB=OFF
make -j$(nproc)
sudo install -m755 programs/libdeflate-gzip /usr/local/bin/libdeflate-gzip
popd
rm -rf libdeflate

popd
